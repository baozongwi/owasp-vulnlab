package com.owaspvulnlab.vulnerability.idor;

import com.owaspvulnlab.entity.User;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import javax.persistence.EntityManager;
import javax.transaction.Transactional;
import java.util.HashMap;
import java.util.Map;

@RestController
@RequestMapping("/api/idor")
@CrossOrigin(origins = "*")
public class IdorController {

    @Autowired
    private EntityManager entityManager;

    @GetMapping("/user/{id}")
    public Map<String, Object> getUserById(@PathVariable Long id) {
        User user = entityManager.find(User.class, id);
        Map<String, Object> result = new HashMap<>();
        if (user == null) {
            result.put("success", false);
            result.put("message", "user not found");
            return result;
        }
        result.put("success", true);
        result.put("id", user.getId());
        result.put("username", user.getUsername());
        result.put("email", user.getEmail());
        result.put("role", user.getRole());
        result.put("secret", user.getSecret());
        return result;
    }

    @PostMapping("/user/update")
    @Transactional
    public Map<String, Object> updateUser(@RequestBody User incoming) {
        User existing = entityManager.find(User.class, incoming.getId());
        Map<String, Object> result = new HashMap<>();
        if (existing == null) {
            result.put("success", false);
            result.put("message", "user not found");
            return result;
        }
        existing.setUsername(incoming.getUsername());
        existing.setPassword(incoming.getPassword());
        existing.setEmail(incoming.getEmail());
        existing.setRole(incoming.getRole());
        existing.setSecret(incoming.getSecret());
        entityManager.merge(existing);
        result.put("success", true);
        result.put("message", "updated");
        result.put("user", existing.toString());
        return result;
    }
}

