package com.owaspvulnlab.vulnerability.deserialization;

import org.springframework.web.bind.annotation.*;

import java.io.*;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

@RestController
@RequestMapping("/api/deser")
@CrossOrigin(origins = "*")
public class DeserializationController {

    @PostMapping("/vulnerable")
    public Map<String, Object> vulnerable(@RequestBody Map<String, String> body) throws IOException, ClassNotFoundException {
        String data = body.get("data");
        byte[] bytes = Base64.getDecoder().decode(data);
        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(bytes));
        Object obj = ois.readObject();
        Map<String, Object> result = new HashMap<>();
        result.put("success", true);
        result.put("type", obj.getClass().getName());
        return result;
    }

    @GetMapping("/payload")
    public Map<String, Object> payload(@RequestParam(value = "msg", required = false) String msg) throws IOException {
        EvilObject eo = new EvilObject(msg == null ? "hello" : msg);
        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(bos);
        oos.writeObject(eo);
        oos.flush();
        String data = Base64.getEncoder().encodeToString(bos.toByteArray());
        Map<String, Object> result = new HashMap<>();
        result.put("data", data);
        return result;
    }
}

