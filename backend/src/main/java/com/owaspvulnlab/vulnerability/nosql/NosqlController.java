package com.owaspvulnlab.vulnerability.nosql;

import com.owaspvulnlab.entity.User;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import javax.persistence.EntityManager;
import javax.persistence.TypedQuery;
import javax.script.ScriptEngine;
import javax.script.ScriptEngineManager;
import javax.script.SimpleBindings;
import java.util.*;
import java.util.regex.Pattern;

@RestController
@RequestMapping("/api/nosql")
@CrossOrigin(origins = "*")
public class NosqlController {

    @Autowired
    private EntityManager entityManager;

    private List<User> allUsers() {
        TypedQuery<User> q = entityManager.createQuery("SELECT u FROM User u", User.class);
        return q.getResultList();
    }

    @GetMapping("/regex")
    public Map<String, Object> regex(@RequestParam("q") String q) {
        Pattern p = Pattern.compile(q);
        List<Map<String, Object>> out = new ArrayList<>();
        for (User u : allUsers()) {
            if (p.matcher(u.getUsername()).find()) {
                Map<String, Object> m = new HashMap<>();
                m.put("id", u.getId());
                m.put("username", u.getUsername());
                m.put("email", u.getEmail());
                m.put("role", u.getRole());
                m.put("secret", u.getSecret());
                out.add(m);
            }
        }
        Map<String, Object> res = new HashMap<>();
        res.put("results", out);
        return res;
    }

    @GetMapping("/where")
    public Map<String, Object> where(@RequestParam("code") String code) throws Exception {
        ScriptEngine engine = new ScriptEngineManager().getEngineByName("nashorn");
        List<Map<String, Object>> out = new ArrayList<>();
        for (User u : allUsers()) {
            SimpleBindings b = new SimpleBindings();
            b.put("id", u.getId());
            b.put("username", u.getUsername());
            b.put("email", u.getEmail());
            b.put("role", u.getRole());
            b.put("secret", u.getSecret());
            Object result = engine.eval(code, b);
            if (result instanceof Boolean && (Boolean) result) {
                Map<String, Object> m = new HashMap<>();
                m.put("id", u.getId());
                m.put("username", u.getUsername());
                m.put("email", u.getEmail());
                m.put("role", u.getRole());
                m.put("secret", u.getSecret());
                out.add(m);
            }
        }
        Map<String, Object> res = new HashMap<>();
        res.put("results", out);
        return res;
    }
}

