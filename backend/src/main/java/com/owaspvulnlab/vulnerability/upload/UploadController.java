package com.owaspvulnlab.vulnerability.upload;

import org.springframework.http.MediaType;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.*;
import java.util.*;

@RestController
@RequestMapping("/api/upload")
@CrossOrigin(origins = "*")
public class UploadController {

    private final Path baseDir = Paths.get("uploads");

    @PostMapping(path = "/file", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public Map<String, Object> uploadFile(@RequestParam("file") MultipartFile file,
                                          @RequestParam(value = "filename", required = false) String filename) throws IOException {
        Files.createDirectories(baseDir);
        String name = StringUtils.hasText(filename) ? filename : Objects.requireNonNull(file.getOriginalFilename());
        Path target = baseDir.resolve(name);
        Files.write(target, file.getBytes(), StandardOpenOption.CREATE, StandardOpenOption.TRUNCATE_EXISTING);
        Map<String, Object> result = new HashMap<>();
        result.put("success", true);
        result.put("path", target.toString());
        return result;
    }

    @GetMapping("/read")
    public Map<String, Object> readFile(@RequestParam("path") String path) throws IOException {
        Path p = Paths.get(path);
        byte[] data = Files.readAllBytes(p);
        Map<String, Object> result = new HashMap<>();
        result.put("success", true);
        result.put("content", new String(data));
        return result;
    }

    @GetMapping("/list")
    public Map<String, Object> listFiles(@RequestParam(value = "dir", required = false) String dir) throws IOException {
        Path d = StringUtils.hasText(dir) ? Paths.get(dir) : baseDir;
        Files.createDirectories(d);
        List<String> files = new ArrayList<>();
        try (DirectoryStream<Path> stream = Files.newDirectoryStream(d)) {
            for (Path path : stream) {
                files.add(path.getFileName().toString());
            }
        }
        Map<String, Object> result = new HashMap<>();
        result.put("success", true);
        result.put("files", files);
        return result;
    }
}

